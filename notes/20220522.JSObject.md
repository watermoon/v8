# JSObject
* src: js-objects.h

## 带着问题阅读代码
* Q1: 既然相同内存布局的 map 只有一个, 那么创建带属性的对象时, 如何快速找到对应的 map(此时没有 map 转移树的引用)
* Q2: 如何创建一个对象
* Q3: 不同的方式构造对象, Map 如何构造和共享[1]
    * 在对象的构造函数或者对象字面量外添加的字段, 不会直接存储在对象上, 而是存储在对象外的一个数组上
    * 一个唯一的构造函数会有唯一的类, 并共享一个 hidden class
    * 布局完全一样的对象字面量(object literal)会共享一个 hidden class

## 问题线索片段
* SetMapAndElements: 设置 JSObject 对象的 map

## 试验
* case1: bytecode 调查
    ```bash
    $ out/x64.debug/d8 --print-bytecode ./new-object.js
    [generated bytecode for function:  (0x2614082d25ed <SharedFunctionInfo>)]
    Parameter count 1
    Register count 1
    Frame size 8
            0x2614082d268e @    0 : 7e 00 00 29       CreateObjectLiteral [0], [0], #41
            0x2614082d2692 @    4 : 15 01 01          StaGlobal [1], [1]
            0x2614082d2695 @    7 : 26 fa             Star r0
            0x2614082d2697 @    9 : ab                Return
    Constant pool (size = 2)
    0x2614082d265d: [FixedArray] in OldSpace
    - map: 0x261408042201 <Map>
    - length: 2
            0: 0x2614082d2639 <ObjectBoilerplateDescription[5]>
            1: 0x2614082d25d1 <String[4]: #obj1>
    Handler Table (size = 0)
    Source Position Table (size = 0)

    # 打印 js 中的对象
    $ out/x64.debug/d8 --allow-natives-syntax --print-bytecode ./new-object.js
    ```
* case2: 创建两个不同的对象, 查看 map 的变化
    ```bash
    $ out/x64.debug/d8 --allow-natives-syntax ./new-object2.js

    # 逐个增加属性的 map, 与一开始就有相同属性的 map 不是同一个 map
    # 解释: https://stackoverflow.com/questions/17925726/clearing-up-the-hidden-classes-concept-of-v8
    ```

## Reference
1. [不同对象构造方式, 造成不同的 Map](https://stackoverflow.com/questions/17925726/clearing-up-the-hidden-classes-concept-of-v8)
2. [Hidden classes and inline caching in V8](https://richardartoul.github.io/jekyll/update/2015/04/26/hidden-classes.html)